<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <title>Lista de Atendimentos</title>
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://moment.github.io/luxon/global/luxon.min.js"></script>
  <style>
    * {
      padding: 0;
      margin: 0;
      vertical-align: baseline;
      list-style: none;
      border: 0;
      text-decoration: none;
    }

    body {
      font-family: "Roboto", sans-serif;
      font-size: 13px;
      text-transform: uppercase;
    }

    h1 {
      font-size: 1.6em;
    }

    h2 {
      font-size: 1.3em;
    }

    h3 {
      margin-top: 30px;
      font-weight: bolder;
      font-size: 1.3em;
    }

    a {
      text-decoration: none;
    }

    body>div#app>div {
      display: grid;
      grid-template-columns: repeat(3, auto);
    }

    body>div#app>div>div {
      padding: 8px;
      border-top: 0.1px solid #dbdbdb;
      display: flex;
      /* justify-content: center; */
      flex-direction: row;
    }

    body>div#app>div>div:nth-child(3n + 2) {
      font-weight: bolder;
    }

    div.header {
      text-align: center;
    }

    .right {
      text-align: right;
    }

    .footer {
      font-size: 0.95em;
      margin-top: 20px;
      line-height: 20px;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>CONGREGAÇÃO CRISTÃ NO BRASIL</h1>
    <h2>LISTA DE ATENDIMENTOS DIVERSOS</h2>
    <u> REGIONAL FAINA</u>
  </div>
  <div id="app">
    <template v-for="tipo in tipos" :key="tipo">
      <h3>{{tipo}}</h3>
      <div>
        <template v-for="row in rows.filter(o=>o.Tipo === tipo)" :key="row">
          <div>{{formatData(row)}}</div>
          <div>{{row.Localidade}}</div>
          <div>{{row.Dirigentes + ' '}} {{row["Observações"]}}</div>
        </template>
      </div>
    </template>
  </div>
  <div class="right">
    <b>
      <p>Acesse a lista em:</p>
      <a href="https://ccbfaina.github.io">https://ccbfaina.github.io</a>
    </b>
  </div>
  <div class="footer">
    <b>
      <i>
        <p>
          Oração Santa Ceia <br />Pão: "Senhor, abençoa este Pão que vamos
          comer, que é a comunhão do Corpo de Cristo."
        </p>
        <p>
          Cálice: "Senhor, abençoa o Cálice que vamos beber, que é a comunhão
          do Sangue de Cristo."
        </p>
      </i>
    </b>
  </div>
  <script>
    const { createApp } = Vue;

    const semanas = ["", "seg", "ter", "qua", "qui", "sex", "sáb", "dom"];
    const DateTime = luxon.DateTime;
    const today = DateTime.now();

    const app = createApp({
      data() {
        return {
          headers: [],
          rows: [],
          tipos: "",
        };
      },
      methods: {
        formatData(row) {
          const d = row.Data;
          try {
            return `${d.toFormat("dd/MM")} ÀS ${row.Hora || "19:30"} (${semanas[d.weekday] || ""
              })`;
          } catch (e) {
            console.log("Erro ao formatar data: ", row.Tipo, row.Localidade);
          }
        },
      },
      mounted() {
        fetch(
          "https://docs.google.com/spreadsheets/d/e/2PACX-1vQtJLYR89kPMbRAiROVU0Vet4pvLSyH_ReKbJcseWnleD1E6DHIupfjPssTc-GHxHA37CtUI04WtUGJ/pub?gid=0&single=true&output=csv",
          {
            redirect: "follow",
          }
        )
          .then((response) => response.text())
          .then((csvData) => {
            console.log("CSV:: ", csvData);
            const lines = csvData.split("\n");
            this.headers = lines[0].split(",").map((el) => el.trim());
            const result = [];
            for (let i = 1; i < lines.length; i++) {
              const obj = {};
              const currentLine = lines[i].split(",");
              for (let j = 0; j < this.headers.length; j++) {
                obj[this.headers[j]] = currentLine[j];
              }
              this.rows.push(obj);
            }
            this.rows = this.rows
              .map((row) => {
                try {
                  if (row.Data) {
                    row.Data = DateTime.fromISO(
                      row.Data.split("/").reverse().join("-")
                    );
                  } else {
                    row.Data = undefined;
                  }
                } catch (e) {
                  row.Data = undefined;
                  console.log("Erro ao formatar dado: ", e);
                }
                return row;
              })
              .filter(
                (row) =>
                  row.Data === undefined ||
                  row.Data.plus({ days: 1 }).diff(today) > 0
              );

            this.rows.sort((a, b) => {
              if (a < b) return -1;
              if (a > b) return 1;
              return 0;
            });

            this.tipos = [
              ...new Set(this.rows.map((item) => item.Tipo)),
            ].sort();
            console.log(
              "Resultado >>>",
              JSON.parse(JSON.stringify(this.rows))
            );
          })
          .catch((error) => {
            console.error("Erro ao obter o arquivo CSV:", error);
          });
      },
    });

    app.mount("#app");
  </script>
</body>

</html>